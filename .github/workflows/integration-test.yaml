name: Integration Test
on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:
env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
jobs:
  build:
    name: Build binary
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build maelstrom-ikada binary
        run: cargo build --release --bin maelstrom-ikada
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: maelstrom-ikada
          path: target/release/maelstrom-ikada
  maelstrom:
    name: Maelstrom (${{ matrix.test-name }})
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-name: "3nodes-basic"
            workload: "lin-kv"
            time-limit: 10
            rate: 10
            node-count: 3
            concurrency: "2n"
            nemesis: ""
            nemesis-interval: ""
          - test-name: "3nodes-partition"
            workload: "lin-kv"
            time-limit: 60
            rate: 10
            node-count: 3
            concurrency: "2n"
            nemesis: "partition"
            nemesis-interval: "5"
          - test-name: "5nodes-partition"
            workload: "lin-kv"
            time-limit: 60
            rate: 10
            node-count: 5
            concurrency: "2n"
            nemesis: "partition"
            nemesis-interval: "5"
    steps:
      - uses: actions/checkout@v4
      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Install Graphviz and Gnuplot
        run: sudo apt-get update && sudo apt-get install -y graphviz gnuplot
      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: maelstrom-ikada
          path: bin/
      - name: Make binary executable
        run: chmod +x bin/maelstrom-ikada
      - name: Cache Maelstrom
        id: cache-maelstrom
        uses: actions/cache@v4
        with:
          path: ~/maelstrom
          key: maelstrom-v0.2.3
      - name: Download Maelstrom
        if: steps.cache-maelstrom.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/jepsen-io/maelstrom/releases/download/v0.2.3/maelstrom.tar.bz2
          tar -xjf maelstrom.tar.bz2
          mv maelstrom ~/maelstrom
      - name: Quick smoke test
        run: |
          ~/maelstrom/maelstrom test \
            -w echo \
            --bin ~/maelstrom/demo/ruby/echo.rb \
            --time-limit 5 \
            --node-count 1
      - name: Run Maelstrom test
        env:
          WORKLOAD: ${{ matrix.workload }}
          TIME_LIMIT: ${{ matrix.time-limit }}
          RATE: ${{ matrix.rate }}
          NODE_COUNT: ${{ matrix.node-count }}
          CONCURRENCY: ${{ matrix.concurrency }}
          NEMESIS: ${{ matrix.nemesis }}
          NEMESIS_INTERVAL: ${{ matrix.nemesis-interval }}
        run: |
          NEMESIS_FLAG=""
          if [ -n "$NEMESIS" ]; then
            NEMESIS_FLAG="--nemesis $NEMESIS"
          fi
          NEMESIS_INTERVAL_FLAG=""
          if [ -n "$NEMESIS_INTERVAL" ]; then
            NEMESIS_INTERVAL_FLAG="--nemesis-interval $NEMESIS_INTERVAL"
          fi
          ~/maelstrom/maelstrom test \
            -w "$WORKLOAD" \
            --bin bin/maelstrom-ikada \
            --time-limit "$TIME_LIMIT" \
            --rate "$RATE" \
            --node-count "$NODE_COUNT" \
            --concurrency "$CONCURRENCY" \
            $NEMESIS_FLAG \
            $NEMESIS_INTERVAL_FLAG
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maelstrom-results-${{ matrix.test-name }}
          path: store/
          retention-days: 7
