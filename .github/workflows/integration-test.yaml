name: Integration Test
on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
jobs:
  build:
    name: Build binary
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build maelstrom-ikada binary
        run: cargo build --release --bin maelstrom-ikada
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: maelstrom-ikada
          path: target/release/maelstrom-ikada
  maelstrom:
    name: Maelstrom (${{ matrix.test-name }})
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-name: "3nodes-basic"
            workload: "lin-kv"
            time-limit: 10
            rate: 10
            node-count: 3
            concurrency: "2n"
            nemesis: ""
            nemesis-interval: ""
          - test-name: "3nodes-partition"
            workload: "lin-kv"
            time-limit: 30
            rate: 20
            node-count: 3
            concurrency: "2n"
            nemesis: "partition"
            nemesis-interval: "3"
          - test-name: "5nodes-partition"
            workload: "lin-kv"
            time-limit: 30
            rate: 20
            node-count: 5
            concurrency: "2n"
            nemesis: "partition"
            nemesis-interval: "3"
    steps:
      - uses: actions/checkout@v4
      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - name: Install Graphviz and Gnuplot
        run: sudo apt-get update && sudo apt-get install -y graphviz gnuplot
      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: maelstrom-ikada
          path: bin/
      - name: Make binary executable
        run: chmod +x bin/maelstrom-ikada
      - name: Cache Maelstrom
        id: cache-maelstrom
        uses: actions/cache@v4
        with:
          path: ~/maelstrom
          key: maelstrom-v0.2.3
      - name: Download Maelstrom
        if: steps.cache-maelstrom.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/jepsen-io/maelstrom/releases/download/v0.2.3/maelstrom.tar.bz2
          tar -xjf maelstrom.tar.bz2
          mv maelstrom ~/maelstrom
      - name: Quick smoke test
        run: |
          ~/maelstrom/maelstrom test \
            -w echo \
            --bin ~/maelstrom/demo/ruby/echo.rb \
            --time-limit 5 \
            --node-count 1
      - name: Run Maelstrom test
        env:
          WORKLOAD: ${{ matrix.workload }}
          TIME_LIMIT: ${{ matrix.time-limit }}
          RATE: ${{ matrix.rate }}
          NODE_COUNT: ${{ matrix.node-count }}
          CONCURRENCY: ${{ matrix.concurrency }}
          NEMESIS: ${{ matrix.nemesis }}
          NEMESIS_INTERVAL: ${{ matrix.nemesis-interval }}
        run: |
          NEMESIS_FLAG=""
          if [ -n "$NEMESIS" ]; then
            NEMESIS_FLAG="--nemesis $NEMESIS"
          fi
          NEMESIS_INTERVAL_FLAG=""
          if [ -n "$NEMESIS_INTERVAL" ]; then
            NEMESIS_INTERVAL_FLAG="--nemesis-interval $NEMESIS_INTERVAL"
          fi
          ~/maelstrom/maelstrom test \
            -w "$WORKLOAD" \
            --bin bin/maelstrom-ikada \
            --time-limit "$TIME_LIMIT" \
            --rate "$RATE" \
            --node-count "$NODE_COUNT" \
            --concurrency "$CONCURRENCY" \
            $NEMESIS_FLAG \
            $NEMESIS_INTERVAL_FLAG
      - name: Extract test statistics
        if: always()
        run: |
          RESULTS_FILE="store/latest/results.edn"
          if [ -f "$RESULTS_FILE" ]; then
            # Extract test status
            if grep -q ":valid? true" "$RESULTS_FILE"; then
              echo "TEST_STATUS=âœ… Success" >> $GITHUB_ENV
            else
              echo "TEST_STATUS=âŒ Failed" >> $GITHUB_ENV
            fi

            # Extract statistics
            STATS=$(grep -A 10 ":stats {" "$RESULTS_FILE" | head -11)

            # Extract count, ok-count, fail-count, info-count
            COUNT=$(echo "$STATS" | grep ":count" | head -1 | grep -oP "\d+" || echo "0")
            OK_COUNT=$(echo "$STATS" | grep ":ok-count" | head -1 | grep -oP "\d+" || echo "0")
            FAIL_COUNT=$(echo "$STATS" | grep ":fail-count" | head -1 | grep -oP "\d+" || echo "0")
            INFO_COUNT=$(echo "$STATS" | grep ":info-count" | head -1 | grep -oP "\d+" || echo "0")

            # Extract availability
            AVAILABILITY=$(grep ":ok-fraction" "$RESULTS_FILE" | grep -oP "[\d.]+" | head -1 || echo "0")
            AVAILABILITY_PCT=$(echo "$AVAILABILITY * 100" | bc -l | xargs printf "%.2f")

            echo "TOTAL_REQUESTS=$COUNT" >> $GITHUB_ENV
            echo "OK_REQUESTS=$OK_COUNT" >> $GITHUB_ENV
            echo "FAIL_REQUESTS=$FAIL_COUNT" >> $GITHUB_ENV
            echo "INFO_REQUESTS=$INFO_COUNT" >> $GITHUB_ENV
            echo "AVAILABILITY=$AVAILABILITY_PCT" >> $GITHUB_ENV
          else
            echo "TEST_STATUS=âŒ No results" >> $GITHUB_ENV
            echo "TOTAL_REQUESTS=0" >> $GITHUB_ENV
            echo "OK_REQUESTS=0" >> $GITHUB_ENV
            echo "FAIL_REQUESTS=0" >> $GITHUB_ENV
            echo "INFO_REQUESTS=0" >> $GITHUB_ENV
            echo "AVAILABILITY=0" >> $GITHUB_ENV
          fi
      - name: Create test summary
        if: always()
        run: |
          mkdir -p test-summaries
          cat > test-summaries/${{ matrix.test-name }}.txt <<EOF
          ${{ matrix.test-name }}|${{ env.TEST_STATUS }}|${{ matrix.workload }}|${{ env.AVAILABILITY }}%|${{ env.TOTAL_REQUESTS }}|${{ env.OK_REQUESTS }}|${{ env.FAIL_REQUESTS }}|${{ env.INFO_REQUESTS }}
          EOF
      - name: Upload test summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-summary-${{ matrix.test-name }}
          path: test-summaries/
          retention-days: 7
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maelstrom-results-${{ matrix.test-name }}
          path: store/
          retention-days: 7
  comment:
    name: Post test results to PR
    runs-on: ubuntu-latest
    needs: maelstrom
    if: ${{ always() && github.event_name == 'pull_request' }}
    permissions:
      pull-requests: write
    steps:
      - name: Download all test summaries
        uses: actions/download-artifact@v4
        with:
          pattern: test-summary-*
          path: summaries/
      - name: Create PR comment
        run: |
          echo "# ðŸ§ª Integration Test Results" > comment.md
          echo "" >> comment.md
          echo "Commit: \`${{ github.sha }}\`" >> comment.md
          echo "" >> comment.md

          # Table header
          echo "| Test Name | Status | Workload | Availability | Total | OK | Failed | Info |" >> comment.md
          echo "|-----------|--------|----------|--------------|-------|----|----|------|" >> comment.md

          # Combine all test summaries
          for dir in summaries/test-summary-*; do
            if [ -d "$dir" ]; then
              for file in "$dir"/*.txt; do
                if [ -f "$file" ]; then
                  # Read the line and convert | to table format
                  line=$(cat "$file")
                  echo "| $line |" | sed 's/|/ | /g' >> comment.md
                fi
              done
            fi
          done

          echo "" >> comment.md
          echo "---" >> comment.md
          echo "*Generated by Integration Test workflow*" >> comment.md
      - name: Post comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ§ª Integration Test Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
